{% extends "layoutAdmin.html" %}

{% block title %}Admin Reports — PharmaCheck{% endblock %}

{% block styles %}
<script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better readability and aesthetics */
        :root {
            --primary: #10B981; /* Emerald Green */
            --secondary: #374151; /* Gray 700 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .sort-icon {
            display: inline-block;
            margin-left: 0.5rem;
            transition: transform 0.2s;
        }
        .sortable:hover {
            cursor: pointer;
            background-color: #e5e7eb;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        /* Style for the fixed header */
        .table-container {
            max-height: 70vh; /* Limit height to enable scrolling */
            overflow-y: auto;
        }
        .table-container table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .table-container thead th {
            position: sticky;
            top: 0;
            background-color: var(--secondary);
            color: white;
            z-index: 10;
        }
    </style>{% endblock %}

{% block content %}

<div id="app" class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <!-- Segmented Control using Tailwind peer utility -->
        <div class="flex justify-center mb-2">
            <!-- Outer container for the segmented control -->
            <div class="flex bg-gray-100 rounded-xl p-1 space-x-1 shadow-lg max-w-lg w-full sm:w-auto items-center">
                
                <!-- Report Option 1: Queries Log Report -->
                <a href="{{ url_for('admin_reports') }}" class="relative flex-1 cursor-pointer select-none transition duration-300 ease-in-out">
                    <!-- Radio Input (Hidden but set as peer) -->
                    <input type="radio" name="report-type" value="queries-log" checked class="peer sr-only">
                    
                    <!-- Visible Button Content (The peer-checked utility applies the active style when the input is checked) -->
                    <span class="block px-6 py-2.5 text-center text-sm font-semibold text-gray-800 rounded-lg transition duration-300 ease-in-out 
                                 peer-checked:bg-green-100 peer-checked:shadow-md peer-checked:shadow-gray-500/30">
                        Queries Log Report
                    </span>
                </a>

                <!-- Report Option 2: Pharm Submissions Report -->
                <a href="{{ url_for('admin_reports2') }}" class="relative flex-1 cursor-pointer select-none transition duration-300 ease-in-out">
                    <!-- Radio Input (Hidden but set as peer) -->
                    <input type="radio" name="report-type" value="pharm-submissions" class="peer sr-only">
                    
                    <!-- Visible Button Content -->
                    <span class="block px-6 py-2.5 text-center text-sm font-semibold text-gray-800 rounded-lg transition duration-300 ease-in-out 
                                 peer-checked:bg-green-100 peer-checked:shadow-md peer-checked:shadow-gray-500/30">
                        Pharm Submissions Report
                    </span>
                </a>
                
            </div>
        </div>
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">
            Pharmacy Query Log Report
        </h1>

        <!-- Filtering and Controls Section -->
        <div class="flex flex-col md:flex-row gap-4 mb-8 items-end bg-gray-50 p-4 rounded-lg shadow-inner">
            <!-- Date Inputs -->
            <div class="flex flex-col flex-grow w-full md:w-auto">
                <label for="start_date" class="text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date" id="start_date" class="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
            </div>
            <div class="flex flex-col flex-grow w-full md:w-auto">
                <label for="end_date" class="text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date" id="end_date" class="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
            </div>

            <!-- Action Buttons -->
            <button id="filter_btn" class="w-full md:w-auto px-4 py-2 bg-emerald-500 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 transition duration-150 transform hover:scale-105">
                <span id="filter_text">Run Report</span>
            </button>
            <button id="pdf_btn" class="w-full md:w-auto px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 transform hover:scale-105 disabled:bg-red-300" disabled>
                Download PDF
            </button>
        </div>

        <!-- Alert/Message Box -->
        <div id="message_box" class="hidden p-3 mb-4 rounded-lg text-sm" role="alert"></div>

        <!-- Report Table Container -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Query Aggregation Results</h2>
            <div class="table-container shadow-md rounded-lg border border-gray-200">
                <table id="report_table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-700 text-white sticky top-0">
                        <tr>
                            <!-- Headers: The 'data-sort' attribute maps to the JSON key -->
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable hover:bg-gray-600" data-sort="serial">
                                Serial Number <span class="sort-icon"></span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable hover:bg-gray-600" data-sort="total_queries">
                                Total Queries <span class="sort-icon"></span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable hover:bg-gray-600" data-sort="authentic_count">
                                Authentic Count <span class="sort-icon"></span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable hover:bg-gray-600" data-sort="unauthentic_count">
                                Counterfeit Count <span class="sort-icon"></span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable hover:bg-gray-600" data-sort="unauthentic_count">
                                Expired Count <span class="sort-icon"></span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable hover:bg-gray-600" data-sort="last_query_timestamp">
                                Last Query <span class="sort-icon"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="report_body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-4 py-4 text-center text-gray-500">Select a date range and click "Run Report" to view data.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading_overlay" class="loading-overlay hidden">
            <svg class="animate-spin h-10 w-10 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-3 text-lg font-medium text-gray-700">Loading Report...</span>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
        // --- Global State ---
        let currentReportData = [];
        let currentSort = { key: 'total_queries', direction: 'desc' }; // Default sort

        // --- Utility Functions ---

        /** Sets the current message/alert box */
        function setMessageBox(message, type = 'info') {
            const box = document.getElementById('message_box');
            box.textContent = message;
            box.className = `p-3 mb-4 rounded-lg text-sm transition-opacity ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            box.classList.remove('hidden');
        }

        /** Clears the message box */
        function clearMessageBox() {
            document.getElementById('message_box').classList.add('hidden');
        }

        /** Shows/hides the loading overlay */
        function setLoading(isLoading) {
            document.getElementById('loading_overlay').classList.toggle('hidden', !isLoading);
            document.getElementById('filter_text').textContent = isLoading ? 'Loading...' : 'Run Report';
            document.getElementById('filter_btn').disabled = isLoading;
            document.getElementById('pdf_btn').disabled = isLoading || currentReportData.length === 0;
        }

        /** Updates the visual sort icons on the table headers */
        function updateSortIcons() {
            document.querySelectorAll('#report_table th.sortable').forEach(th => {
                const icon = th.querySelector('.sort-icon');
                icon.textContent = ''; // Clear existing icon

                if (th.dataset.sort === currentSort.key) {
                    icon.textContent = currentSort.direction === 'asc' ? '▲' : '▼';
                }
            });
        }

        /**
         * Renders the data into the HTML table body.
         * @param {Array} data - The aggregated report data.
         */
        function renderTable(data) {
            const tbody = document.getElementById('report_body');
            tbody.innerHTML = '';
            currentReportData = data;
            document.getElementById('pdf_btn').disabled = data.length === 0;

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">No query logs found for this date range.</td></tr>`;
                return;
            }

            // Apply current sort to the data before rendering
            data.sort((a, b) => {
                const valA = a[currentSort.key];
                const valB = b[currentSort.key];

                let comparison = 0;
                // Handle numerical and string comparison
                if (typeof valA === 'number' && typeof valB === 'number') {
                    comparison = valA - valB;
                } else if (valA > valB) {
                    comparison = 1;
                } else if (valA < valB) {
                    comparison = -1;
                }

                return currentSort.direction === 'asc' ? comparison : comparison * -1;
            });

            data.forEach(item => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-100';

                // Serial Number
                let cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900';
                cell.textContent = item.serial;

                // Total Queries
                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-center';
                cell.textContent = item.total_queries;

                // Authentic Count
                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-center font-semibold';
                cell.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">${item.authentic_count}</span>`;

                // Counterfeit Count
                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-center font-semibold';
                cell.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">${item.counterfeit_count}</span>`;

                // Expired Count
                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-center font-semibold';
                cell.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">${item.expired_count}</span>`;

                // Last Query Timestamp
                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500';
                cell.textContent = item.last_query_timestamp || 'N/A';
            });

            updateSortIcons();
        }

        /**
         * Fetches aggregated data from the Flask backend API.
         */
        async function fetchReport() {
            clearMessageBox();
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;

            if (!startDate || !endDate) {
                setMessageBox('Please select both a start and end date.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                 setMessageBox('Start date cannot be after the end date.', 'error');
                 return;
            }

            setLoading(true);

            // Construct the API URL
            const apiUrl = `/api/report?start_date=${startDate}&end_date=${endDate}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (!response.ok) {
                    setMessageBox(`Error fetching report: ${data.error || response.statusText}`, 'error');
                    renderTable([]); // Clear table on error
                    return;
                }

                renderTable(data);
                setMessageBox(`Report successfully generated for ${data.length} unique serials.`, 'success');

            } catch (error) {
                console.error('API Fetch Error:', error);
                setMessageBox('Failed to connect to the server or API endpoint.', 'error');
                renderTable([]); // Clear table on error
            } finally {
                setLoading(false);
            }
        }

        /**
         * Initiates the PDF download process by sending the current report data to the Flask endpoint.
         */
        async function downloadPdf() {
            clearMessageBox();
            if (currentReportData.length === 0) {
                setMessageBox('Cannot generate PDF: The report table is empty.', 'error');
                return;
            }

            setLoading(true);

            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;

            try {
                const response = await fetch('/api/generate_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reportData: currentReportData,
                        startDate: startDate,
                        endDate: endDate
                    })
                });

                if (response.ok) {
                    // Trigger file download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `pharm_log_report_${startDate}_to_${endDate}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    setMessageBox('PDF successfully generated and downloaded!', 'success');
                } else {
                    const errorData = await response.json();
                    setMessageBox(`PDF generation failed: ${errorData.error || response.statusText}`, 'error');
                }

            } catch (error) {
                console.error('PDF Download Error:', error);
                setMessageBox('A network error occurred while trying to generate the PDF.', 'error');
            } finally {
                setLoading(false);
            }
        }

        /**
         * Event handler for table header clicks to perform sorting.
         * @param {Event} e - The click event.
         */
        function handleSort(e) {
            const th = e.currentTarget;
            const sortKey = th.dataset.sort;

            if (currentReportData.length === 0) return;

            if (currentSort.key === sortKey) {
                // Toggle direction
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New sort key, default to descending for numbers, ascending for strings
                currentSort.key = sortKey;
                const isNumeric = ['total_queries', 'authentic_count', 'unauthentic_count'].includes(sortKey);
                currentSort.direction = isNumeric ? 'desc' : 'asc';
            }

            renderTable(currentReportData); // Re-render with sorted data
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date range (e.g., last 30 days)
            const today = new Date();
            const lastMonth = new Date(today);
            lastMonth.setDate(today.getDate() - 30);

            const formatDate = (date) => date.toISOString().split('T')[0];

            document.getElementById('start_date').value = formatDate(lastMonth);
            document.getElementById('end_date').value = formatDate(today);

            // Attach event listeners
            document.getElementById('filter_btn').addEventListener('click', fetchReport);
            document.getElementById('pdf_btn').addEventListener('click', downloadPdf);

            // Attach sorting listeners
            document.querySelectorAll('#report_table th.sortable').forEach(th => {
                th.addEventListener('click', handleSort);
            });

            // Run initial report on page load
            fetchReport();
        });
    </script>
{% endblock %}
